# Story 6.9: CI Pipeline Fixes

## Status

Draft - Awaiting PM Review

## Story

**As a** contributor to WriteScore,
**I want** CI pipelines to pass on all PR checks,
**so that** code can be merged without workarounds and the project maintains quality standards.

## Background

Epic 6 implementation is complete but two CI jobs are failing, blocking the PR from being merge-ready:

1. **pre-commit job** - Fails due to trailing whitespace in bundled text files
2. **dependency-review job** - Fails due to missing GitHub repository configuration

These must be fixed before the Epic 6 PR can be offered to the upstream project.

## Acceptance Criteria

### AC1: Pre-commit CI Job Passes

1. All files pass trailing whitespace checks
2. All files pass end-of-file fixer checks
3. Pre-commit CI job completes with success status

### AC2: Dependency Review CI Job Passes

1. GitHub Dependency Graph is enabled on the repository
2. dependency-review-action runs successfully
3. No high-severity vulnerabilities block the PR

### AC3: Test Matrix Jobs Pass

1. All Python version matrix jobs (3.9, 3.10, 3.11, 3.12) pass
2. Unit tests pass across all versions
3. Integration tests pass across all versions

## Root Cause Analysis

### Pre-commit Failure

The pre-commit CI job runs `pre-commit run --all-files` which includes:
- `trim trailing whitespace` hook
- `end-of-file-fixer` hook

Files in `web-bundles/teams/*.txt` contain trailing whitespace that wasn't cleaned before commit. The hooks modify these files, causing the CI job to fail.

**Error from logs:**
```
diff --git a/web-bundles/teams/team-ide-minimal.txt
-      Adaptive, risk-aware comprehensive review.
+      Adaptive, risk-aware comprehensive review.
```

**Fix options:**
1. Run `pre-commit run --all-files` locally and commit the cleaned files
2. Or exclude `web-bundles/` from pre-commit hooks if these files shouldn't be modified

### Dependency Review Failure

The `actions/dependency-review-action@v4` requires GitHub's Dependency Graph feature to be enabled on the repository.

**Error from logs:**
```
Dependency review is not supported on this repository.
Please ensure that Dependency graph is enabled, see
https://github.com/arcaven/writescore/settings/security_analysis
```

**Fix:**
1. Go to Repository Settings → Security → Code security and analysis
2. Enable "Dependency graph"
3. Optionally enable "Dependabot alerts" and "Dependabot security updates"

## Tasks

### Task 1: Fix Trailing Whitespace in Bundled Files

- [ ] Run `pre-commit run trailing-whitespace --all-files` locally
- [ ] Run `pre-commit run end-of-file-fixer --all-files` locally
- [ ] Review changes in `web-bundles/` directory
- [ ] Commit cleaned files with message: `style: fix trailing whitespace in bundled files`

### Task 2: Enable Dependency Graph

- [ ] Navigate to https://github.com/arcaven/writescore/settings/security_analysis
- [ ] Enable "Dependency graph"
- [ ] Verify dependency-review job passes on next CI run

### Task 3: Verify Test Matrix Jobs

- [ ] Monitor test jobs for Python 3.9, 3.10, 3.11, 3.12
- [ ] Document any failures and their causes
- [ ] Fix any test failures that are not pre-existing upstream issues

## Dependencies

**Depends On:** Story 6.8 (Mypy Type Compliance) - COMPLETE

**Blocks:** Epic 6 PR merge to upstream

## Definition of Done

- [ ] Pre-commit CI job passes
- [ ] Dependency-review CI job passes
- [ ] All test matrix jobs pass
- [ ] PR shows all checks passing (green)
- [ ] No new issues introduced

## Notes

The test matrix jobs (Python 3.9, 3.10, 3.11, 3.12) are currently running. Their status should be monitored. Expected test failures:
- 4 tests in `test_dual_score_calculator.py` (pre-existing upstream issue)
- 3 tests requiring `sentence-transformers` (optional dependency)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-07 | 1.0 | Initial story creation based on CI failures | Dev Team |
