# Story 6.8: Mypy Type Compliance

## Status

Ready for Development

## Story

**As a** contributor to WriteScore,
**I want** the codebase to pass mypy type checking,
**so that** type errors are caught early and the pre-commit hook doesn't block commits.

## Background

The pre-commit configuration includes mypy for type checking, but the existing codebase has 176 type errors across 35 files. This blocks contributors from committing without using `SKIP=mypy`.

## Acceptance Criteria

### Phase 1: Critical Fixes (Unblock Pre-commit)

1. All `[assignment]` errors fixed (57 errors) - primarily implicit Optional issues
2. All `[var-annotated]` errors fixed (27 errors) - missing type annotations
3. All `[override]` errors fixed (21 errors) - method signature mismatches
4. Mypy passes with `--ignore-missing-imports` flag
5. Pre-commit hook no longer requires `SKIP=mypy`

### Phase 2: Type Stub Installation

6. Install type stubs for marko, scipy, and other untyped dependencies
7. Remove `--ignore-missing-imports` from mypy configuration
8. All `[import-untyped]` errors resolved

### Phase 3: Strict Mode (Optional)

9. Enable stricter mypy settings incrementally
10. Document mypy configuration in pyproject.toml

## Error Summary

| Error Type | Count | Description |
|------------|-------|-------------|
| `[assignment]` | 57 | Implicit Optional, type mismatches |
| `[var-annotated]` | 27 | Missing type annotations on variables |
| `[override]` | 21 | Method signatures don't match base class |
| `[arg-type]` | 23 | Wrong argument types |
| `[dict-item]` | 15 | Dict type mismatches |
| `[attr-defined]` | 8 | Accessing attributes on None |
| `[return-value]` | 5 | Return type mismatches |
| `[operator]` | 5 | Operator type issues |
| `[index]` | 5 | Invalid index types |
| `[union-attr]` | 4 | Accessing attributes on union types |
| Other | 6 | Various other issues |
| **Total** | **176** | |

## Files by Error Count

| File | Errors | Priority |
|------|--------|----------|
| `dimensions/structure.py` | 21 | High |
| `history/trends.py` | 18 | High |
| `core/parameter_loader.py` | 14 | High |
| `core/parameter_derivation.py` | 10 | Medium |
| `core/recalibration.py` | 9 | Medium |
| `cli/formatters.py` | 8 | Medium |
| `dimensions/pragmatic_markers.py` | 7 | Medium |
| `core/analyzer.py` | 7 | Medium |
| Other (27 files) | 82 | Low |

## Tasks / Subtasks

### Phase 1: Fix Implicit Optional Issues

- [ ] **Task 1: Fix assignment errors** (AC: 1)
  - [ ] Add `Optional[]` wrapper or `| None` to parameters with default `None`
  - [ ] Fix `no_implicit_optional` violations across all files
  - [ ] Focus on: base_strategy.py, domain_thresholds.py, dimensions/*.py

- [ ] **Task 2: Add missing type annotations** (AC: 2)
  - [ ] Add type hints to untyped variables (dicts, lists, sets)
  - [ ] Focus on: text_processing.py, base_strategy.py, __init__.py files

- [ ] **Task 3: Fix override signature mismatches** (AC: 3)
  - [ ] Align `tier` property signatures in dimension subclasses
  - [ ] Align `analyze` method signatures in dimension subclasses
  - [ ] Ensure return types match base class

### Phase 2: Fix Remaining Type Errors

- [ ] **Task 4: Fix argument type errors** (AC: 4)
  - [ ] Fix dict-item type mismatches
  - [ ] Fix arg-type mismatches in function calls

- [ ] **Task 5: Fix attribute access on None** (AC: 4)
  - [ ] Add None checks before attribute access
  - [ ] Use `assert` or `if` guards for Optional types

- [ ] **Task 6: Verify mypy passes** (AC: 4, 5)
  - [ ] Run `mypy src/writescore --ignore-missing-imports`
  - [ ] Verify 0 errors
  - [ ] Test pre-commit hook works without SKIP

### Phase 3: Type Stubs (Optional)

- [ ] **Task 7: Install type stubs** (AC: 6, 7)
  - [ ] Add `types-*` packages for untyped dependencies
  - [ ] Update pyproject.toml with type stub dependencies
  - [ ] Remove `--ignore-missing-imports` if all stubs available

## Dependencies

**Depends On:** None

**Blocks:** None (but improves developer experience)

**Related:** Epic 6 (Developer Experience)

---

## Dev Notes

### Common Fix Patterns

**Implicit Optional (most common):**
```python
# Before
def foo(x: str = None):  # Error: default None but type is str

# After
def foo(x: str | None = None):  # Or: Optional[str] = None
```

**Missing annotation:**
```python
# Before
my_dict = {}  # Error: Need type annotation

# After
my_dict: dict[str, int] = {}
```

**Override mismatch:**
```python
# Base class
@property
def tier(self) -> DimensionTier: ...

# Subclass - must match exactly
@property
def tier(self) -> DimensionTier: ...  # Not just "return type"
```

### Mypy Configuration

Add to `pyproject.toml`:
```toml
[tool.mypy]
python_version = "3.9"
warn_return_any = true
warn_unused_ignores = true
ignore_missing_imports = true  # Remove after adding stubs
```

### Testing

```bash
# Run mypy
uv run --with mypy mypy src/writescore --ignore-missing-imports

# Count errors
uv run --with mypy mypy src/writescore --ignore-missing-imports 2>&1 | grep "Found .* errors"

# Test pre-commit
git add -A && git commit --dry-run -m "test: mypy check"
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-07 | 1.0 | Initial story creation | PM Agent (John) |
