# Story 4.3: CI/CD & Release Automation

## Status

Approved

## Story

**As a** writescore maintainer,
**I want** GitHub Actions CI/CD and automated release workflows,
**so that** code quality is automatically verified and releases are consistently published.

## Acceptance Criteria

1. `.github/workflows/ci.yml` created for continuous integration
2. CI workflow triggers on push to `main` and on pull requests
3. CI runs: Python linting (ruff), unit tests, integration tests
4. CI tests against Python 3.8, 3.10, and 3.12
5. `.github/workflows/release.yml` created for release automation
6. Release workflow triggers on version tags (v*)
7. Releases include auto-generated release notes from commits
8. CHANGELOG.md follows Keep a Changelog format
9. Version defined in single location (pyproject.toml `project.version`)
10. README.md includes CI status badge
11. First CI-triggered release (v6.3.0) successfully created via workflow

## Tasks / Subtasks

- [x] **Task 1: Create CI Workflow** (AC: 1, 2, 3, 4)
  - [x] Create `.github/workflows/ci.yml`
  - [x] Configure trigger on push to main
  - [x] Configure trigger on pull_request
  - [x] Set up Python matrix: [3.8, 3.10, 3.12]
  - [x] Add linting step (ruff)
  - [x] Add unit test step
  - [x] Add integration test step
  - [x] Configure test results reporting
  - [x] Add coverage upload (optional: codecov)

- [x] **Task 2: Create Release Workflow** (AC: 5, 6, 7)
  - [x] Create `.github/workflows/release.yml`
  - [x] Configure trigger on tags matching `v*`
  - [x] Build Python package (wheel + sdist)
  - [x] Create GitHub Release
  - [x] Auto-generate release notes from commits
  - [x] Attach built artifacts to release
  - [ ] Optional: Publish to PyPI (test.pypi.org initially)

- [x] **Task 3: Configure Linting** (AC: 3)
  - [x] Add ruff configuration to pyproject.toml (see Dev Notes for full config):
    ```toml
    [tool.ruff]
    line-length = 100
    target-version = "py38"

    [tool.ruff.lint]
    select = [
        "E",      # pycodestyle errors
        "F",      # pyflakes
        "W",      # pycodestyle warnings
        "I",      # isort
        "UP",     # pyupgrade
        "B",      # flake8-bugbear
        "C4",     # flake8-comprehensions
        "SIM",    # flake8-simplify
    ]
    ignore = [
        "E501",   # line too long (handled by formatter)
        "B008",   # function call in default argument
        "SIM108", # ternary operator
    ]

    [tool.ruff.lint.per-file-ignores]
    "tests/*" = ["S101", "PLR2004"]  # allow assert and magic values in tests

    [tool.ruff.lint.isort]
    known-first-party = ["writescore"]
    ```
  - [x] Run `ruff check src/writescore tests` and fix critical issues
  - [x] Document any intentionally ignored rules in pyproject.toml comments

- [x] **Task 4: Verify & Update CHANGELOG** (AC: 8)
  - [x] Verify CHANGELOG.md already follows Keep a Changelog format (it does)
  - [x] Add v6.3.0 release section with CI/CD additions:
    ```markdown
    ## [6.3.0] - 2025-11-XX
    ### Added
    - GitHub Actions CI/CD pipeline (.github/workflows/ci.yml)
    - Automated release workflow (.github/workflows/release.yml)
    - CI status badge in README.md
    - ruff linting configuration in pyproject.toml

    ### Changed
    - Version now read dynamically in __init__.py via importlib.metadata
    ```
  - [x] Update [Unreleased] link at bottom of file
  - [x] Ensure version links at bottom include v6.3.0

- [x] **Task 5: Consolidate Version Management** (AC: 9)
  - [x] Verify version is ONLY in pyproject.toml (currently 6.1.0, will bump to 6.3.0)
  - [x] Bump version in pyproject.toml to 6.3.0
  - [x] Update `src/writescore/__init__.py` to read version dynamically:
    - Current state: hardcoded `__version__ = '5.0.0'` (out of sync!)
    - Replace with:
    ```python
    from importlib.metadata import version, PackageNotFoundError
    try:
        __version__ = version("writescore")
    except PackageNotFoundError:
        __version__ = "0.0.0.dev0"  # Fallback for editable installs without metadata
    ```
  - [x] Verify `writescore --version` works after `pip install -e .`

- [x] **Task 6: Update README with Badges** (AC: 10)
  - [x] Add CI status badge:
    ```markdown
    [![CI](https://github.com/BOHICA-LABS/writescore/actions/workflows/ci.yml/badge.svg)](https://github.com/BOHICA-LABS/writescore/actions/workflows/ci.yml)
    ```
  - [x] Add Python version badge
  - [x] Add license badge
  - [x] Update installation instructions for new repo
  - [x] Update any outdated documentation links

- [ ] **Task 7: Create First CI-Triggered Release** (AC: 11)
  - [ ] Ensure all CI passes on main
  - [ ] Create and push tag: `git tag v6.3.0 && git push origin v6.3.0`
  - [ ] Verify release workflow triggers
  - [ ] Verify GitHub Release is created at https://github.com/BOHICA-LABS/writescore/releases
  - [ ] Verify release notes are generated
  - [ ] Verify artifacts (wheel + sdist) are attached

## Dev Notes

### Relevant Source Tree

```
writescore/
├── .github/
│   └── workflows/
│       ├── ci.yml           # NEW - CI workflow
│       └── release.yml      # NEW - Release workflow
├── src/
│   └── writescore/
│       └── __init__.py      # MODIFY - dynamic version
├── pyproject.toml           # MODIFY - add ruff config, bump version
├── README.md                # MODIFY - add badges
└── CHANGELOG.md             # MODIFY - add v6.3.0 entry
```

### Current State (Pre-Implementation)
- **pyproject.toml version**: 6.1.0 (will bump to 6.3.0)
- **__init__.py version**: Hardcoded '5.0.0' (out of sync - will fix)
- **CHANGELOG**: Already follows Keep a Changelog format
- **GitHub repo**: https://github.com/BOHICA-LABS/writescore

### CI Workflow (.github/workflows/ci.yml)

```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff
      - name: Lint with ruff
        run: ruff check src/writescore tests

  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.8", "3.10", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          python -m spacy download en_core_web_sm

      - name: Run unit tests
        run: pytest tests/unit -v --tb=short

      - name: Run integration tests
        run: pytest tests/integration -v --tb=short

      - name: Run coverage
        if: matrix.python-version == '3.12'
        run: |
          pytest --cov=writescore --cov-report=xml tests/

      - name: Upload coverage
        if: matrix.python-version == '3.12'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}  # Required for v4
```

### Release Workflow (.github/workflows/release.yml)

```yaml
name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: python -m build

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            dist/*.whl
            dist/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Optional: Publish to PyPI
      # - name: Publish to PyPI
      #   env:
      #     TWINE_USERNAME: __token__
      #     TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      #   run: twine upload dist/*
```

### Ruff Configuration (pyproject.toml addition)

```toml
[tool.ruff]
line-length = 100
target-version = "py38"

[tool.ruff.lint]
select = [
    "E",      # pycodestyle errors
    "F",      # pyflakes
    "W",      # pycodestyle warnings
    "I",      # isort
    "UP",     # pyupgrade
    "B",      # flake8-bugbear
    "C4",     # flake8-comprehensions
    "SIM",    # flake8-simplify
]
ignore = [
    "E501",   # line too long (handled by formatter)
    "B008",   # function call in default argument
    "SIM108", # ternary operator
]

[tool.ruff.lint.per-file-ignores]
"tests/*" = ["S101", "PLR2004"]  # allow assert and magic values in tests

[tool.ruff.lint.isort]
known-first-party = ["writescore"]
```

### Keep a Changelog Format Reference

- **Added** for new features
- **Changed** for changes in existing functionality
- **Deprecated** for soon-to-be removed features
- **Removed** for now removed features
- **Fixed** for any bug fixes
- **Security** in case of vulnerabilities

### Version Badge Examples

```markdown
[![CI](https://github.com/BOHICA-LABS/writescore/actions/workflows/ci.yml/badge.svg)](https://github.com/BOHICA-LABS/writescore/actions/workflows/ci.yml)
[![Python 3.8+](https://img.shields.io/badge/python-3.8+-blue.svg)](https://www.python.org/downloads/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
```

### Troubleshooting & Rollback

**If CI workflow fails after merge:**
1. Check workflow logs at https://github.com/BOHICA-LABS/writescore/actions
2. Fix issues in a new PR
3. CI will re-run on the fix PR

**If release workflow creates broken release:**
1. Delete the release from GitHub Releases page
2. Delete the tag: `git push origin :refs/tags/v6.3.0`
3. Fix issues, create new tag with incremented version

**If tag was pushed but release failed:**
1. Check workflow logs for failure reason
2. Fix the issue (usually permissions or secrets)
3. Re-run the failed workflow from Actions tab, OR
4. Delete tag and re-push: `git tag -d v6.3.0 && git push origin :refs/tags/v6.3.0`

**Local testing with `act` (optional):**
```bash
# Install act: brew install act (macOS) or see https://github.com/nektos/act
act -l                    # List available workflows
act push                  # Test push event
act pull_request          # Test PR event
```

## Testing

### Testing Standards (from Architecture)

- **Test file location**: `tests/` directory at project root
- **Test frameworks**: pytest with pytest-cov for coverage
- **Test commands**:
  ```bash
  pytest tests/unit -v --tb=short      # Unit tests
  pytest tests/integration -v          # Integration tests
  pytest --cov=writescore tests/       # With coverage
  ```
- **CI requirements**:
  - All tests must pass on Python 3.8, 3.10, and 3.12
  - Linting must pass (ruff check)
  - Coverage should not decrease

### Story-Specific Verification

1. **CI Workflow Verification**:
   - Push a test commit to a feature branch
   - Open PR to main → CI should trigger
   - Verify all matrix jobs (3.8, 3.10, 3.12) run
   - Verify lint job runs separately

2. **Release Workflow Verification**:
   - After CI passes on main, create tag: `git tag v6.3.0`
   - Push tag: `git push origin v6.3.0`
   - Verify workflow triggers at https://github.com/BOHICA-LABS/writescore/actions
   - Verify release appears at https://github.com/BOHICA-LABS/writescore/releases
   - Verify wheel and sdist artifacts attached

3. **Version Verification**:
   ```bash
   pip install -e .
   writescore --version  # Should show 6.3.0
   python -c "import writescore; print(writescore.__version__)"  # Should show 6.3.0
   ```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-25 | 1.0 | Initial story creation | Sarah (PO Agent) |
| 2025-11-25 | 1.1 | Validation remediation: Fixed version refs (6.1.0→6.3.0), corrected GitHub org (BOHICA-LABS), added source tree, updated action versions (codecov v4, gh-release v2), aligned ruff config, added Testing section and rollback guidance, fixed __init__.py sync task | Sarah (PO Agent) |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

N/A

### Completion Notes List

1. **CI Workflow**: Created `.github/workflows/ci.yml` with lint job (ruff) and test job with Python matrix (3.8, 3.10, 3.12). Includes Codecov integration for coverage reporting.

2. **Release Workflow**: Created `.github/workflows/release.yml` triggered on `v*` tags. Builds wheel/sdist and creates GitHub Release with auto-generated notes.

3. **Ruff Linting**: Added comprehensive ruff configuration. Fixed 144+ lint issues across 20+ files including:
   - Import ordering (I001)
   - Exception chaining (B904)
   - Unused loop variables (B007)
   - Nested conditionals (SIM102)
   - Ambiguous variable names (E741)
   - Context manager usage (SIM115)
   - One test file bug fix (F821 - undefined variables)

4. **E712 Semantic Fix**: Critical fix in `dual_score_calculator.py:185` - kept `== False` check with `noqa: E712` comment. The auto-fix to `not metrics.get('available')` broke semantics because `not None` evaluates to `True`, incorrectly treating all dimensions as unavailable.

5. **Python 3.8 Compatibility**: Kept nested `with` statements (vs parenthesized) with `noqa: SIM117` for 3.8 compatibility.

6. **Version Consolidation**: Single source of truth in `pyproject.toml` (6.3.0). `__init__.py` now uses `importlib.metadata` for dynamic versioning.

7. **All Tests Pass**: 1968 passed, 0 failed after fixes.

### File List

**Created:**
- `.github/workflows/ci.yml` - CI workflow
- `.github/workflows/release.yml` - Release workflow

**Modified:**
- `pyproject.toml` - Version bump to 6.3.0, ruff configuration
- `src/writescore/__init__.py` - Dynamic versioning
- `CHANGELOG.md` - v6.3.0 entry
- `README.md` - Badges added
- `src/writescore/scoring/dual_score_calculator.py` - E712 noqa fix
- `src/writescore/cli/main.py` - Import ordering, exception chaining
- `src/writescore/cli/formatters.py` - Import ordering, variable renames
- `src/writescore/core/analyzer.py` - Import ordering, exception chaining, context managers
- `src/writescore/core/dimension_loader.py` - Import ordering
- `src/writescore/core/dimension_registry.py` - Import ordering
- `src/writescore/core/analysis_config.py` - Import ordering
- `src/writescore/dimensions/*.py` - Various lint fixes across all dimension files
- `src/writescore/utils/*.py` - Import ordering, lint fixes
- `src/writescore/scoring/dual_score.py` - Import ordering
- `tests/unit/dimensions/test_syntactic.py` - Bug fix (undefined variables)
- Multiple test files - Import ordering fixes

## QA Results

*To be filled by QA agent*
