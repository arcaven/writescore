# Story 4.2: Test & Documentation Migration

## Status

Done

## Story

**As a** writescore maintainer,
**I want** tests and documentation migrated to repository root with proper configuration,
**so that** the project follows standard Python project conventions and all tests pass.

## Acceptance Criteria

1. `tests/` directory at repository root with all test files preserved
2. Test directory structure mirrors source structure (tests/unit/core/, tests/unit/cli/, etc.)
3. `docs/` directory at repository root with all documentation
4. `scripts/` directory at repository root with utility scripts
5. pytest.ini or pyproject.toml [tool.pytest] properly configured for src-layout
6. All test fixtures and data files accessible from new locations
7. `pytest` runs successfully from repository root
8. All unit tests pass (target: 100% of current passing tests)
9. All integration tests pass
10. Test coverage reporting works (`pytest --cov=writescore`)
11. No hardcoded paths broken by migration

## Tasks / Subtasks

- [x] **Task 1: Migrate Test Directory** (AC: 1, 2)
  - [x] Copy `tests/` to repository root
  - [x] Preserve directory structure:
    - [x] tests/unit/core/
    - [x] tests/unit/cli/
    - [x] tests/unit/dimensions/
    - [x] tests/unit/scoring/
    - [x] tests/unit/utils/
    - [x] tests/unit/history/
    - [x] tests/integration/
    - [x] tests/accuracy/
    - [x] tests/performance/
    - [x] tests/regression/
    - [x] tests/utils/
  - [x] Copy root-level test file: `tests/test_cli_refactoring_regression.py`
  - [x] Copy tests/conftest.py
  - [x] Copy tests/__init__.py files at all levels

- [x] **Task 2: Migrate Test Fixtures** (AC: 6)
  - [x] Copy `tests/fixtures/` to repository root tests/
  - [x] Verify fixture files:
    - [x] baseline_scores.json
    - [x] regression_corpus.json
    - [x] sample_ai_text.md
    - [x] sample_human_text.md
    - [x] sample_mixed_text.md
    - [x] sample_edge_cases.md
    - [x] section-1.1-final.md
    - [x] section-1.2.md
  - [x] Update any hardcoded fixture paths in conftest.py

- [x] **Task 3: Update Test Imports** (AC: 8, 9, 11)
  - [x] Audit all test files for import statements
  - [x] Update imports to use `from writescore.x import y`
  - [x] Verify conftest.py fixtures work with new imports
  - [x] Check for any `sys.path` manipulation and remove/update
  - [x] Verify no relative imports remain: `grep -rn "^from \." tests/`

- [x] **Task 4: Configure pytest** (AC: 5, 7, 10)
  - [x] Add pytest configuration to pyproject.toml:
    ```toml
    [tool.pytest.ini_options]
    testpaths = ["tests"]
    python_files = ["test_*.py"]
    python_classes = ["Test*"]
    python_functions = ["test_*"]
    addopts = "-v --tb=short"
    filterwarnings = [
        "ignore::DeprecationWarning",
        "ignore::PendingDeprecationWarning",
    ]
    markers = [
        "slow: marks tests as slow",
        "integration: marks integration tests",
    ]
    ```
  - [x] Configure coverage in pyproject.toml:
    ```toml
    [tool.coverage.run]
    source = ["src/writescore"]
    branch = true
    omit = ["*/tests/*", "*/__pycache__/*"]

    [tool.coverage.report]
    exclude_lines = [
        "pragma: no cover",
        "def __repr__",
        "raise NotImplementedError",
    ]
    ```
  - [x] Remove standalone pytest.ini (consolidate into pyproject.toml)

- [x] **Task 5: Migrate Documentation** (AC: 3)
  - [x] Copy `docs/` to repository root
  - [x] Preserve structure:
    - [x] docs/stories/ (all story files)
    - [x] docs/research/
    - [x] docs/qa/
    - [x] All guide/reference docs
  - [x] Update any internal doc links if needed

- [x] **Task 6: Migrate Scripts** (AC: 4)
  - [x] Copy `scripts/` to repository root
  - [x] Verify script files:
    - [x] scripts/generate_validation_corpus.py
    - [x] scripts/README.md
  - [x] Update any script imports/paths
  - [x] Verify scripts are executable (`chmod +x` if needed)
  - [x] Update script shebangs if needed

- [x] **Task 7: Run Full Test Suite** (AC: 7, 8, 9, 10)
  - [x] Create fresh virtual environment
  - [x] Install package: `pip install -e ".[dev]"`
  - [x] Run unit tests: `pytest tests/unit/ -v`
  - [x] Run integration tests: `pytest tests/integration/ -v`
  - [x] Run with coverage: `pytest --cov=writescore --cov-report=html`
  - [x] Compare pass/fail counts with original
  - [x] Document any failing tests and reasons

## Dev Notes

### Test Directory Structure (Target)

```
writescore/                    (repo root)
├── src/writescore/            (from Story 4.1)
├── tests/
│   ├── __init__.py
│   ├── conftest.py
│   ├── test_cli_refactoring_regression.py  (root-level test file)
│   ├── fixtures/
│   │   ├── README.md
│   │   ├── baseline_scores.json
│   │   ├── regression_corpus.json
│   │   ├── sample_ai_text.md
│   │   ├── sample_human_text.md
│   │   ├── sample_mixed_text.md
│   │   ├── sample_edge_cases.md
│   │   ├── section-1.1-final.md
│   │   └── section-1.2.md
│   ├── unit/
│   │   ├── __init__.py
│   │   ├── core/
│   │   │   ├── __init__.py
│   │   │   ├── test_analyzer.py
│   │   │   ├── test_dimension_registry.py
│   │   │   └── ...
│   │   ├── cli/
│   │   ├── dimensions/
│   │   ├── scoring/
│   │   ├── utils/
│   │   └── history/
│   ├── integration/
│   │   ├── __init__.py
│   │   ├── test_scoring_regression.py
│   │   └── ...
│   ├── accuracy/
│   │   └── ...
│   ├── performance/
│   │   ├── __init__.py
│   │   ├── test_gltr_performance.py
│   │   ├── test_recalibration_robustness.py
│   │   ├── test_scoring_optimization_validation.py
│   │   └── test_story_2_6_validation.py
│   ├── regression/
│   │   └── __init__.py
│   └── utils/
│       ├── README.md
│       └── capture_baselines.py
├── docs/
│   ├── stories/
│   ├── qa/
│   ├── ACCURACY-CLAIMS-AUDIT-2025.md
│   ├── ANALYSIS-INDEX.md
│   ├── analysis-modes-guide.md
│   ├── CODEBASE-ANALYSIS.md
│   ├── configuration.md
│   ├── CONTENT-TYPE-DIMENSION-MAPPING.md
│   ├── DIMENSION-ENHANCEMENT-ANALYSIS-2025.md
│   ├── DIMENSION-INVENTORY.txt
│   ├── MIGRATION-v5.0.0.md
│   ├── PERCENTILE-SCORING.md
│   └── ...
└── scripts/
    ├── generate_validation_corpus.py
    └── README.md
```

### conftest.py Updates Required

The conftest.py likely needs updates for fixture paths:

```python
# BEFORE
FIXTURES_DIR = Path(__file__).parent / "fixtures"

# AFTER (should still work, but verify)
FIXTURES_DIR = Path(__file__).parent / "fixtures"

# Also check for any sys.path manipulation:
# REMOVE lines like:
# sys.path.insert(0, str(Path(__file__).parent.parent))
```

### pyproject.toml Test Configuration

Add to existing pyproject.toml from Story 4.1:

```toml
[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = ["test_*.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
addopts = "-v --tb=short"
filterwarnings = [
    "ignore::DeprecationWarning",
    "ignore::PendingDeprecationWarning",
]
markers = [
    "slow: marks tests as slow (deselect with '-m \"not slow\"')",
    "integration: marks integration tests",
    "accuracy: marks accuracy validation tests",
]
timeout = 300

[tool.coverage.run]
source = ["src/writescore"]
branch = true
omit = [
    "*/tests/*",
    "*/__pycache__/*",
    "*/htmlcov/*",
]

[tool.coverage.report]
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "raise NotImplementedError",
    "if TYPE_CHECKING:",
]
show_missing = true

[tool.coverage.html]
directory = "htmlcov"
```

### Pre-Migration Test Baseline (Reference)

From source test suite run on 2025-11-25 (verify these match after migration):

| Metric | Count |
|--------|-------|
| **Total Passed** | 1975 |
| **Total Failed** | 1 |
| **Total Skipped** | 17 |
| **Coverage** | 89% |

**Known Failure**: `test_sampling_detects_human_text` in accuracy tests (pre-existing issue, not migration-related)

**Test Directory File Counts**:
- tests/unit/ - 6 subdirectories (core, cli, dimensions, scoring, utils, history)
- tests/integration/ - integration test files
- tests/accuracy/ - accuracy validation tests
- tests/performance/ - 4 test files
- tests/regression/ - placeholder only (__init__.py)
- tests/utils/ - test utilities

### Testing

#### Testing Standards

- Framework: pytest
- Coverage tool: pytest-cov
- Test naming: `test_*.py` files, `test_*` functions
- Fixtures: Shared fixtures in conftest.py
- Markers: `@pytest.mark.slow`, `@pytest.mark.integration`, `@pytest.mark.accuracy`

#### Verification Commands

```bash
# Verify installation
pip install -e ".[dev]"

# Run all tests
pytest tests/ -v

# Run with coverage
pytest --cov=writescore --cov-report=html tests/

# Verify test counts match baseline
pytest tests/ --tb=line -q 2>&1 | tail -5
```

### Rollback Guidance

If migration causes issues:

1. **Source preserved**: Original tests remain in `.bmad-technical-writing/data/tools/writescore/tests/`
2. **Git recovery**: Use `git checkout HEAD -- tests/` to restore from last commit
3. **Verification**: Run test suite against original location to confirm source integrity
4. **Incremental approach**: If full migration fails, migrate directory-by-directory to isolate issues

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-25 | 1.0 | Initial story creation | Sarah (PO Agent) |
| 2025-11-25 | 1.1 | Validation remediation: Added tests/performance/ and tests/regression/ directories to Task 1; Added root-level test file test_cli_refactoring_regression.py; Added explicit scripts file list to Task 6; Updated Dev Notes target structure with complete directory tree; Added pre-migration test baseline (1975 passed, 1 failed, 17 skipped); Added import verification command to Task 3; Added Testing subsection with verification commands; Added rollback guidance | Sarah (PO Agent) |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None - no blocking issues encountered.

### Completion Notes List

1. **Test Migration**: Successfully migrated all test directories from source to `/Users/jmagady/Dev/writescore/tests/` preserving structure
2. **Import Updates**: Removed `sys.path` manipulation from 2 files (capture_baselines.py, test_story_2_6_validation.py)
3. **CLI Test Updates**: Updated `tests/integration/test_cli_modes.py` to use installed `writescore` CLI entry point instead of legacy `analyze_ai_patterns.py` script
4. **pyproject.toml**: Added complete pytest and coverage configuration
5. **Test Results**:
   - **Pre-migration baseline**: 1975 passed, 1 failed, 17 skipped
   - **Post-migration results**: 1977 passed, 0 failed, 16 skipped
   - Result: **BETTER** than baseline (+2 passed, -1 failed, -1 skipped)
6. **Dependencies installed**: spacy model `en_core_web_sm`, sentence-transformers for semantic features

### File List

**New files at `/Users/jmagady/Dev/writescore/`:**
- tests/ (entire directory with all subdirectories)
- docs/ (entire directory with stories/, research/, qa/)
- scripts/ (generate_validation_corpus.py, README.md)

**Modified files:**
- pyproject.toml (added pytest and coverage configuration)
- tests/integration/test_cli_modes.py (updated CLI invocation to use `writescore` entry point)
- tests/utils/capture_baselines.py (removed sys.path manipulation)
- tests/performance/test_story_2_6_validation.py (removed sys.path manipulation)

## QA Results

### Review Date: 2025-11-25

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation is comprehensive and well-executed. The migration follows standard Python project conventions with src-layout compatibility. Test infrastructure is properly configured with pytest.ini_options in pyproject.toml. All acceptance criteria verified through file inspection and test execution.

### Refactoring Performed

None required. Implementation was clean and followed best practices.

### Compliance Check

- Coding Standards: ✓ All imports use package-qualified form (`from writescore.x import y`)
- Project Structure: ✓ Follows standard Python src-layout conventions
- Testing Strategy: ✓ pytest + pytest-cov properly configured
- All ACs Met: ✓ All 11 acceptance criteria verified

### AC Verification Summary

| AC | Requirement | Verified |
|----|-------------|----------|
| 1 | `tests/` at repo root with all files preserved | ✓ |
| 2 | Test structure mirrors source (unit/core/, unit/cli/, etc.) | ✓ |
| 3 | `docs/` at repo root with all documentation | ✓ |
| 4 | `scripts/` at repo root with utilities | ✓ |
| 5 | pytest configured in pyproject.toml | ✓ |
| 6 | Test fixtures accessible from new locations | ✓ |
| 7 | pytest runs from repo root | ✓ |
| 8 | All unit tests pass | ✓ |
| 9 | All integration tests pass | ✓ |
| 10 | Coverage reporting works | ✓ |
| 11 | No hardcoded paths broken | ✓ |

### Test Results Verification

**Pre-migration baseline**: 1975 passed, 1 failed, 17 skipped
**Post-migration actual**: 1977 passed, 0 failed, 16 skipped

**Improvement**: +2 passed, -1 failed, -1 skipped

### Improvements Checklist

- [x] Directory structure verified (tests/, docs/, scripts/)
- [x] All fixture files present and accessible
- [x] pytest configuration complete in pyproject.toml
- [x] Coverage configuration complete
- [x] No sys.path manipulation in test files
- [x] CLI tests use `writescore` entry point
- [x] No relative imports in test files

### Security Review

No security concerns. Migration is purely structural and does not affect runtime behavior or expose sensitive data.

### Performance Considerations

No performance concerns. Test suite execution time is acceptable (~21 minutes for full suite). Coverage collection works correctly.

### Files Modified During Review

None.

### Gate Status

Gate: **PASS** → docs/qa/gates/4.2-test-documentation-migration.yml

### Recommended Status

✓ Ready for Done

All acceptance criteria verified. Test suite passes with better results than baseline. Migration is complete and properly structured.
