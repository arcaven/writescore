# Story 3.5: Person Consistency Dimension

**Status:** ✅ APPROVED
**Parent Epic:** Content-Aware Analysis System (Epic 3.0) - New Dimensions
**Estimated Effort:** 1-2 days
**Dependencies:** Story 1.4.11 (Dimension Registry)
**Priority:** MEDIUM-HIGH (Common AI error pattern)
**Target Version:** 1.5.0

---

## Story

As a **technical writer analyzing document quality**,
I want **the analyzer to detect inconsistent person/perspective** (mixing I/we/you/they inappropriately),
so that **I can identify AI-like perspective shifts and maintain appropriate voice consistency**.

---

## Acceptance Criteria

### AC1: Person Detection
- [ ] Detects 1st person: I, me, my, mine, we, us, our, ours
- [ ] Detects 2nd person: you, your, yours
- [ ] Detects 3rd person: he, she, they, him, her, them, his, hers, their, theirs
- [ ] Calculates person distribution ratios (1st%, 2nd%, 3rd%)
- [ ] Returns dominant person and mixing score

### AC2: Mixing Detection
- [ ] Mixing score: 1 - max(person_ratio) (0=consistent, 1=perfectly mixed)
- [ ] Consistent single person (mixing <0.15): EXCELLENT
- [ ] Minor mixing (0.15-0.30): GOOD
- [ ] Moderate mixing (0.30-0.50): NEEDS WORK
- [ ] Heavy mixing (>0.50): POOR (AI-like)

### AC3: Content-Aware Assessment
- [ ] **Academic**: 3rd person only (1st person <5% = EXCELLENT)
- [ ] **Professional Bio**: 3rd person only (1st person 0% = EXCELLENT)
- [ ] **Personal Statement**: 1st person dominant (1st person >80% = EXCELLENT)
- [ ] **Blog**: 1st/2nd person mixed OK (1st+2nd >70% = GOOD)
- [ ] **Technical Docs**: 2nd person dominant (2nd person >60% = EXCELLENT)
- [ ] **Technical Book**: 1st/2nd mixed OK for examples+instructions

### AC4: Self-Registration
- [ ] Dimension auto-registers via `@register_dimension` decorator
- [ ] Included in `balanced` and `full` dimension profiles
- [ ] Included in `fast` profile (lightweight pronoun counting)

### AC5: Report Output
- [ ] Shows person distribution: `1st: 45%, 2nd: 35%, 3rd: 20%`
- [ ] Shows dominant person and mixing score
- [ ] Flags inappropriate mixing: "Mixing 1st and 3rd person in professional bio"
- [ ] Provides actionable guidance based on content type

### AC6: Performance
- [ ] Completes analysis in <0.01s for 10,000 word documents
- [ ] Memory usage <100KB (simple pronoun counting)
- [ ] No external dependencies (regex-based)

### AC7: Testing Coverage
- [ ] Unit tests achieve ≥85% coverage
- [ ] Test all person detection (1st, 2nd, 3rd)
- [ ] Test mixing score calculation
- [ ] Test content-aware assessments
- [ ] Test edge cases (zero pronouns, single person only)

---

## Tasks/Subtasks

### Task 1: Core Dimension Implementation (0.5 days)
- [ ] Create `writescore/dimensions/person_consistency.py`
- [ ] Implement `PersonConsistencyDimension(BaseDimensionStrategy)`
- [ ] Define person pronoun sets (1st, 2nd, 3rd)
- [ ] Implement `@register_dimension` decorator
- [ ] Add to all dimension profiles (fast, balanced, full)

### Task 2: Person Analysis Logic (0.25 days)
- [ ] Implement `detect_person_distribution(text) -> Dict[str, float]`
  - Returns: `{'1st': 0.45, '2nd': 0.35, '3rd': 0.20}`
- [ ] Implement `calculate_mixing_score(distribution) -> float`
  - Formula: `1 - max(distribution.values())`
- [ ] Implement `get_dominant_person(distribution) -> str`

### Task 3: Content-Aware Thresholds (0.25 days)
- [ ] Define person thresholds in CONTENT_TYPE_THRESHOLDS
- [ ] Academic: 3rd person dominant
- [ ] Professional Bio: 3rd person only
- [ ] Personal Statement: 1st person dominant
- [ ] Technical Docs: 2nd person dominant
- [ ] Integrate with content type scoring

### Task 4: Report Formatting (0.1 days)
- [ ] Format dimension score output
- [ ] Show person distribution percentages
- [ ] Flag inappropriate mixing by content type
- [ ] Provide actionable recommendations

### Task 5: Testing (0.25 days)
- [ ] Unit tests for person detection
- [ ] Unit tests for mixing score calculation
- [ ] Content-aware assessment tests
- [ ] Edge case tests (no pronouns, single person)
- [ ] Performance benchmarks

### Task 6: Documentation (0.1 days)
- [ ] Update CHANGELOG.md
- [ ] Add dimension to README
- [ ] Document person detection logic
- [ ] Provide usage examples

---

## Dev Notes

### Background Context

**Problem**: AI systems often mix person/perspective inappropriately:
- "I want to help you understand this concept. The reader will learn..." (mixing 1st, 2nd, 3rd)
- "As a director, one must ensure you follow best practices" (mixing 3rd, 2nd)
- "We developed this system. Users should..." (mixing 1st, 3rd)

Human writers maintain consistent perspective within sections/paragraphs. Person mixing is an AI signal.

**Content Type Expectations**:

| Content Type | Expected Person | Distribution | Assessment |
|--------------|-----------------|--------------|------------|
| Academic | 3rd person | 3rd: >90% | EXCELLENT |
| Professional Bio | 3rd person | 3rd: 100%, 1st: 0% | EXCELLENT |
| Personal Statement | 1st person | 1st: >80% | EXCELLENT |
| Blog | 1st + 2nd | 1st+2nd: >70% | GOOD |
| Technical Docs | 2nd person | 2nd: >60% | EXCELLENT |
| Technical Book | 1st + 2nd mixed | 1st+2nd: >60% | GOOD |
| Business | 1st + 2nd | 1st+2nd: >60% | GOOD |
| Creative | 1st or 3rd | 1st: >80% OR 3rd: >80% | EXCELLENT |
| News | 3rd person | 3rd: >95% | EXCELLENT |

### Implementation Strategy

**1. Person Pronoun Sets**
```python
# writescore/dimensions/person_consistency.py

FIRST_PERSON = {
    'i', 'me', 'my', 'mine', 'myself',
    'we', 'us', 'our', 'ours', 'ourselves'
}

SECOND_PERSON = {
    'you', 'your', 'yours', 'yourself', 'yourselves'
}

THIRD_PERSON = {
    'he', 'him', 'his', 'himself',
    'she', 'her', 'hers', 'herself',
    'they', 'them', 'their', 'theirs', 'themselves',
    'it', 'its', 'itself',
    'one', 'oneself'
}

@register_dimension
class PersonConsistencyDimension(BaseDimensionStrategy):
    """Detects inconsistent person/perspective mixing"""

    dimension_name = "person_consistency"

    def analyze(self, text: str, content_type: Optional[str] = None) -> Dict[str, Any]:
        """Detect person mixing patterns"""
        words = self._tokenize(text)
        words_lower = [w.lower() for w in words]

        # Count person pronoun usage
        first_count = sum(1 for w in words_lower if w in FIRST_PERSON)
        second_count = sum(1 for w in words_lower if w in SECOND_PERSON)
        third_count = sum(1 for w in words_lower if w in THIRD_PERSON)

        total_pronouns = first_count + second_count + third_count

        if total_pronouns == 0:
            return {
                'distribution': {'1st': 0.0, '2nd': 0.0, '3rd': 0.0},
                'dominant_person': 'none',
                'mixing_score': 0.0,
                'assessment': 'EXCELLENT',  # No mixing possible
            }

        # Calculate distribution
        distribution = {
            '1st': first_count / total_pronouns,
            '2nd': second_count / total_pronouns,
            '3rd': third_count / total_pronouns,
        }

        # Calculate mixing score (1 - dominance)
        mixing_score = 1 - max(distribution.values())

        # Get dominant person
        dominant_person = max(distribution, key=distribution.get)

        # Content-aware assessment
        assessment = self._assess_person_consistency(
            distribution,
            mixing_score,
            dominant_person,
            content_type
        )

        return {
            'distribution': distribution,
            'dominant_person': dominant_person,
            'mixing_score': mixing_score,
            'assessment': assessment,
            'counts': {
                '1st': first_count,
                '2nd': second_count,
                '3rd': third_count,
            }
        }

    def _assess_person_consistency(
        self,
        distribution: Dict[str, float],
        mixing_score: float,
        dominant_person: str,
        content_type: Optional[str]
    ) -> str:
        """Assess person consistency based on content type"""

        # Generic assessment (no content type)
        if content_type is None:
            if mixing_score < 0.15:
                return 'EXCELLENT'  # Consistent single person
            elif mixing_score < 0.30:
                return 'GOOD'  # Minor mixing
            elif mixing_score < 0.50:
                return 'NEEDS WORK'  # Moderate mixing
            else:
                return 'POOR'  # Heavy mixing (AI-like)

        # Content-aware assessment
        if content_type == 'academic':
            if distribution['3rd'] >= 0.90:
                return 'EXCELLENT'
            elif distribution['3rd'] >= 0.70:
                return 'GOOD'
            else:
                return 'POOR'  # 1st/2nd person inappropriate

        elif content_type == 'professional_bio':
            if distribution['3rd'] == 1.0:
                return 'EXCELLENT'
            elif distribution['3rd'] >= 0.95:
                return 'GOOD'
            else:
                return 'POOR'  # 1st person inappropriate

        elif content_type == 'personal_statement':
            if distribution['1st'] >= 0.80:
                return 'EXCELLENT'
            elif distribution['1st'] >= 0.60:
                return 'GOOD'
            else:
                return 'POOR'  # Not personal enough

        elif content_type == 'technical_docs':
            if distribution['2nd'] >= 0.60:
                return 'EXCELLENT'
            elif distribution['2nd'] >= 0.40:
                return 'GOOD'
            else:
                return 'NEEDS WORK'

        elif content_type == 'blog' or content_type == 'technical_book':
            # Mixed 1st/2nd OK
            if distribution['1st'] + distribution['2nd'] >= 0.70:
                return 'GOOD'
            else:
                return 'NEEDS WORK'

        else:
            # Fallback to generic mixing score
            return 'GOOD' if mixing_score < 0.30 else 'NEEDS WORK'

    def format_results(self, results: Dict[str, Any]) -> str:
        """Format dimension results for report"""
        output = []

        distribution = results['distribution']
        dominant = results['dominant_person']
        mixing_score = results['mixing_score']

        output.append(f"Person Distribution: 1st: {distribution['1st']*100:.0f}%, "
                     f"2nd: {distribution['2nd']*100:.0f}%, "
                     f"3rd: {distribution['3rd']*100:.0f}%")

        output.append(f"Dominant: {dominant} person, Mixing: {mixing_score:.2f}")

        if mixing_score >= 0.30:
            output.append(f"\n⚠ High person mixing detected (AI-like pattern)")
            output.append("→ ACTION: Maintain consistent perspective throughout")

        return "\n".join(output)
```

**2. Content Type Thresholds**
```python
# Add to CONTENT_TYPE_THRESHOLDS in content_type_config.py

'academic': {
    'person_consistency': {
        'third_person_ratio': {
            'EXCELLENT': (0.90, 1.00),
            'GOOD': (0.70, 0.95),
            'NEEDS_WORK': (0.50, 0.70),
            'POOR': (0.00, 0.50),
        }
    }
},
'professional_bio': {
    'person_consistency': {
        'third_person_ratio': {
            'EXCELLENT': (1.00, 1.00),  # Strict 3rd person only
            'GOOD': (0.95, 1.00),
            'NEEDS_WORK': (0.90, 0.95),
            'POOR': (0.00, 0.90),
        }
    }
},
'personal_statement': {
    'person_consistency': {
        'first_person_ratio': {
            'EXCELLENT': (0.80, 1.00),
            'GOOD': (0.60, 0.85),
            'NEEDS_WORK': (0.40, 0.60),
            'POOR': (0.00, 0.40),
        }
    }
},
```

**3. Example Output**
```
Person Consistency: POOR (Mixing: 0.55)

Person Distribution: 1st: 40%, 2nd: 35%, 3rd: 25%
Dominant: 1st person, Mixing: 0.60

⚠ High person mixing detected (AI-like pattern)
→ ACTION: Maintain consistent perspective throughout

For professional bio: Use 3rd person only (he/she/they)
For personal statement: Use 1st person primarily (I/we)
```

### Performance Requirements

- **Analysis Time**: <0.01s for 10,000 word documents
- **Memory**: <100KB (simple pronoun sets)
- **No External Dependencies**: Pure regex/set matching

### Testing Requirements

**Unit Tests** (≥85% coverage):
```python
def test_detect_first_person_dominant():
    """Text with primarily 1st person pronouns"""
    text = "I want to help you understand my perspective. We can work together."

    dimension = PersonConsistencyDimension()
    results = dimension.analyze(text)

    assert results['dominant_person'] == '1st'
    assert results['distribution']['1st'] > 0.50

def test_detect_person_mixing():
    """Text mixing multiple persons"""
    text = "I want to help you. The reader will understand. We can assist them."

    dimension = PersonConsistencyDimension()
    results = dimension.analyze(text)

    assert results['mixing_score'] >= 0.30  # Significant mixing
    assert results['assessment'] in ['NEEDS WORK', 'POOR']

def test_professional_bio_third_person():
    """Professional bio should use 3rd person only"""
    text = "John is a director. He leads teams and develops strategies."

    dimension = PersonConsistencyDimension()
    results = dimension.analyze(text, content_type='professional_bio')

    assert results['distribution']['3rd'] == 1.0
    assert results['assessment'] == 'EXCELLENT'

def test_personal_statement_first_person():
    """Personal statement should use 1st person primarily"""
    text = "I have always been passionate about technology. My experiences taught me..."

    dimension = PersonConsistencyDimension()
    results = dimension.analyze(text, content_type='personal_statement')

    assert results['distribution']['1st'] >= 0.80
    assert results['assessment'] == 'EXCELLENT'
```

### Documentation Requirements

**CHANGELOG.md**:
```markdown
## [1.5.0] - 2025-XX-XX

### Added
- **Person Consistency Dimension** (Story 3.5): Detects person/perspective mixing
  - Identifies 1st, 2nd, 3rd person pronoun usage
  - Calculates person distribution and mixing score
  - Content-aware assessment (academic=3rd, personal statement=1st, technical docs=2nd)
  - Reports inappropriate mixing patterns
  - Lightweight (included in fast profile)
```

---

## QA Results

### Test Coverage
- [ ] Unit tests: ___% (Target: ≥85%)
- [ ] Person detection accuracy: 100%
- [ ] Content-aware tests: 9/9 content types

### Performance Benchmarks
- [ ] Analysis time (10k words): ___ms (Target: <10ms)
- [ ] Memory usage: ___KB (Target: <100KB)

---

## Change Log

| Date | Author | Change | Status |
|------|--------|--------|--------|
| 2025-01-XX | jmagady | Initial story creation | APPROVED |
