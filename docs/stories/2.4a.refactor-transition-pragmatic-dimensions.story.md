# Story 2.4.0.5: Refactor Transition and Pragmatic Marker Dimensions

**Status**: Done
**Estimated Effort**: 6-10 hours
**Dependencies**: None (refactors existing Story 2.2 implementation)
**Priority**: High (Prerequisite for Story 2.4.1)
**Target Version**: v6.0.0

---

## Story

**As a** data scientist maintaining the WriteScore analyzer,
**I want** pragmatic markers extracted into a separate dimension AND formulaic transitions merged into transition markers,
**so that** each dimension has clear, non-overlapping responsibility and Story 2.4.1 can optimize scoring independently.

---

## Background & Context

### Current State Analysis

**Problem 1: transition_marker.py combines two dimensions**
- Transition markers (however, moreover) - discourse structure
- Pragmatic markers (might, may, I believe) - epistemic stance
- Research shows these have distinct statistical properties (μ=22 vs μ=30 per 1k words)

**Problem 2: Formulaic transitions split across files**
- `perplexity.py` detects: "Furthermore, Moreover, Additionally, In conclusion"
- `transition_marker.py` detects: "however, moreover"
- **These are the same linguistic phenomenon!** Should be in ONE dimension

### Solution

**Three-way refactor**:
1. **pragmatic_markers.py** (NEW) - Epistemic hedging, certainty, speech acts (52 patterns)
2. **transition_marker.py** (EXPANDED) - Basic transitions + formulaic transitions (18+ patterns)
3. **perplexity.py** (REDUCED) - Remove formulaic transitions, prepare for true perplexity implementation

---

## Acceptance Criteria

### AC1: Pragmatic Markers Dimension Created
- [x] Create `pragmatic_markers.py` as new dimension file
- [x] Extract from transition_marker.py:
  - Epistemic hedging patterns (20 patterns: might, may, could, about, almost, etc.)
  - Frequency hedges (6 patterns: frequently, occasionally, sometimes, etc.)
  - Epistemic verbs (8 patterns: assume, estimate, indicate, etc.)
  - Certainty markers (10 patterns: definitely, I believe, clearly, etc.)
  - Speech act patterns (8 patterns: I argue, We propose, etc.)
- [x] Total: 52 patterns in pragmatic_markers.py
- [x] Weight: 4% (see AC4)
- [x] Tier: ADVANCED
- [x] Self-registers with DimensionRegistry

### AC2: Transition Markers Dimension Expanded
- [x] Keep existing transition patterns from transition_marker.py:
  - "however" detection (AI: 5-10+/1k, Human: 0-3/1k)
  - "moreover" detection (AI: 3-8+/1k, Human: 0-1/1k)
  - Marker clustering patterns
- [x] Add formulaic transitions from perplexity.py/utils/pattern_matching.py:
  - Furthermore, Moreover, Additionally, In addition
  - First and foremost, In conclusion, To summarize, In summary
  - It is important to note that, It is worth mentioning that
  - When it comes to, With that said, Having said that
  - (Total: 19 formulaic transition patterns from FORMULAIC_TRANSITIONS)
- [x] Update version to v2.0.0
- [x] Weight: 6% (see AC4)
- [x] Combines basic + formulaic transitions as unified dimension

### AC3: Perplexity Dimension Reduced (Preparation)
- [x] Remove formulaic transition detection from perplexity.py
- [x] Keep AI vocabulary detection (temporary - will be extracted in Story 2.4.0.6)
- [x] Update docstring to reflect reduced scope
- [x] Add comment: "Formulaic transitions moved to transition_marker.py (Story 2.4.0.5)"
- [x] Add TODO: "AI vocabulary will be extracted to ai_vocabulary.py (Story 2.4.0.6)"
- [x] Add TODO: "True perplexity calculation will be implemented (Story 2.4.0.7)"
- [x] Weight remains 5% (unchanged for now)

### AC4: Weight Distribution Finalized
- [x] Original combined weight: transition_marker.py = 10%
- [x] New distribution:
  - **transition_marker.py**: 6% (basic + formulaic transitions)
  - **pragmatic_markers.py**: 4% (epistemic markers)
- [x] Total unchanged: 10%
- [x] Rationale: Transition markers (combined) show stronger signal per research
- [x] All dimensions still sum to 100%

### AC5: Backward Compatibility Maintained
- [x] All existing unit tests pass
- [x] New tests created for pragmatic_markers.py
- [x] Updated tests for expanded transition_marker.py
- [x] API signatures unchanged (DimensionStrategy.analyze())
- [x] Aggregate scores remain comparable (variance ≤ ±5 points on test corpus)
- [x] Migration is non-breaking for users

### AC6: Registry and Shared Patterns Updated
- [x] DimensionRegistry recognizes all 3 dimensions
- [x] FORMULAIC_TRANSITIONS in utils/pattern_matching.py used by transition_marker.py
- [x] No duplicate pattern definitions
- [x] All dimensions auto-load and register
- [x] Dimension count: 12 (was 11 files, now 12 files for 12 conceptual dimensions)

### AC7: Tests Comprehensive
- [x] test_pragmatic_markers.py created with 52 pattern tests
- [x] test_transition_marker.py updated with formulaic transition tests
- [x] test_perplexity.py updated (formulaic transitions removed)
- [x] Integration tests verify non-overlapping responsibilities
- [x] Regression tests ensure stable aggregate scores

---

## Tasks / Subtasks

- [x] **Task 1: Create pragmatic_markers.py** (AC: 1) (2-3 hours)
  - [x] Copy transition_marker.py as template
  - [x] Rename class: `TransitionMarkerDimension` → `PragmaticMarkersDimension`
  - [x] Update dimension_name: `"pragmatic_markers"`
  - [x] Extract only pragmatic marker patterns (52 total):
    - EPISTEMIC_HEDGES (20)
    - FREQUENCY_HEDGES (6)
    - EPISTEMIC_VERBS (8)
    - CERTAINTY_MARKERS (10)
    - SPEECH_ACT_PATTERNS (8)
  - [x] Remove transition-specific patterns
  - [x] Set weight to 4%
  - [x] Set tier to ADVANCED
  - [x] Update docstring and description
  - [x] Self-register with DimensionRegistry
  - [x] Implement analyze() for pragmatic markers only

- [x] **Task 2: Expand transition_marker.py** (AC: 2) (2-3 hours)
  - [x] Remove all pragmatic marker patterns
  - [x] Keep transition marker patterns (however, moreover, clustering)
  - [x] Import FORMULAIC_TRANSITIONS from utils/pattern_matching
  - [x] Add formulaic transition analysis:
    - [x] Create `_analyze_formulaic_transitions()` method
    - [x] Detect patterns: Furthermore, Moreover, Additionally, etc.
    - [x] Count per 1k words
    - [x] Score formulaic usage (AI overuses these)
  - [x] Update composite scoring:
    - [x] Basic transitions: 50% (however, moreover)
    - [x] Formulaic transitions: 50% (Furthermore, Moreover, etc.)
  - [x] Update version to v2.0.0
  - [x] Set weight to 6%
  - [x] Update docstring: "Analyzes transition markers: basic discourse markers (however, moreover) and formulaic transitions (Furthermore, Moreover, Additionally)"

- [x] **Task 3: Reduce perplexity.py Scope** (AC: 3) (1 hour)
  - [x] Remove formulaic transition imports and detection
  - [x] Remove TRANSITION_REPLACEMENTS dictionary (moved to transition_marker.py)
  - [x] Update analyze() method to remove transition analysis
  - [x] Update calculate_score() to remove transition component
  - [x] Keep AI vocabulary detection (temporary)
  - [x] Update docstring:
    ```python
    """
    Perplexity dimension analyzer (TEMPORARY STATE - See Stories 2.4.0.6, 2.4.0.7).

    Currently analyzes AI vocabulary patterns (will be extracted to ai_vocabulary.py in Story 2.4.0.6).
    Formulaic transitions moved to transition_marker.py (Story 2.4.0.5).
    True perplexity calculation will be implemented in Story 2.4.0.7.
    """
    ```
  - [x] Add TODO comments for future refactoring
  - [x] Weight remains 5% (unchanged)

- [x] **Task 4: Update Shared Pattern Utilities** (AC: 6) (30 minutes)
  - [x] Verify FORMULAIC_TRANSITIONS in utils/pattern_matching.py
  - [x] Add documentation: "Used by: transition_marker.py"
  - [x] Ensure patterns accessible to transition_marker.py
  - [x] No duplicate pattern definitions across files

- [x] **Task 5: Update Tests** (AC: 5, 7) (3-4 hours)
  - [x] Create test_pragmatic_markers.py:
    - [x] Test all 52 pragmatic marker patterns
    - [x] Test epistemic hedging detection
    - [x] Test certainty marker detection
    - [x] Test speech act detection
    - [x] Test scoring function
    - [x] Test per-1k-word normalization
  - [x] Update test_transition_marker.py:
    - [x] Remove pragmatic marker tests
    - [x] Add formulaic transition tests (18 patterns)
    - [x] Test composite scoring (basic + formulaic)
    - [x] Test expanded pattern detection
    - [x] Update expected counts
  - [x] Update test_perplexity.py:
    - [x] Remove formulaic transition tests
    - [x] Keep AI vocabulary tests
    - [x] Update expected behavior (reduced scope)
    - [x] Add TODOs for Story 2.4.0.6, 2.4.0.7
  - [x] Run full test suite (85%+ coverage maintained)

- [x] **Task 6: Integration Testing** (AC: 5, 6) (1-2 hours)
  - [x] Verify DimensionRegistry discovers all 3 dimensions
  - [x] Verify 12 dimensions in analysis results
  - [x] Test no overlapping pattern detection
  - [x] Test aggregate score calculation
  - [x] Run regression tests on sample documents
  - [x] Compare scores before/after (should be similar)
  - [x] Flag any dramatic changes (>10 points) for investigation

- [x] **Task 7: Documentation** (AC: 5) (1 hour)
  - [x] Update CHANGELOG.md:
    ```markdown
    ## v6.0.0 (Pending)

    ### Breaking Changes
    - **Dimension Refactoring** (Story 2.4.0.5):
      - Pragmatic markers extracted from transition_marker.py → pragmatic_markers.py
      - Formulaic transitions merged from perplexity.py → transition_marker.py
      - transition_marker.py now combines basic + formulaic transitions (6% weight)
      - pragmatic_markers.py new dimension (4% weight, 52 patterns)
      - perplexity.py reduced scope (formulaic transitions removed, AI vocab temporary)
      - Total dimension count: 12 files
    ```
  - [x] Update Story 2.2 status: "Done (Refactored in 2.4.0.5)"
  - [x] Update dimension inventory documentation
  - [x] Add migration notes

---

## Dev Notes

### Implementation Strategy

**Phased Approach**:
1. **Phase 1**: Create pragmatic_markers.py (extract)
2. **Phase 2**: Expand transition_marker.py (add formulaic)
3. **Phase 3**: Reduce perplexity.py (remove formulaic)
4. **Phase 4**: Update tests and verify
5. **Phase 5**: Integration testing and documentation

**Risk Mitigation**:
- Use existing working patterns (low risk)
- All tests must pass before merge
- Regression testing on sample documents
- Verify non-overlapping responsibilities

### Relevant Source Tree

```
.bmad-technical-writing/data/tools/writescore/
├── dimensions/
│   ├── transition_marker.py       (MODIFY - remove pragmatic, add formulaic, v2.0.0)
│   ├── pragmatic_markers.py       (CREATE - extract pragmatic markers, 52 patterns)
│   ├── perplexity.py              (MODIFY - remove formulaic transitions)
│   └── base_strategy.py           (NO CHANGES)
├── utils/
│   └── pattern_matching.py        (NO CHANGES - FORMULAIC_TRANSITIONS already defined)
├── core/
│   ├── dimension_registry.py      (NO CHANGES - auto-discovers new file)
│   └── dimension_loader.py        (NO CHANGES - auto-loads new file)
├── tests/
│   └── unit/dimensions/
│       ├── test_transition_marker.py  (MODIFY - remove pragmatic, add formulaic)
│       ├── test_pragmatic_markers.py  (CREATE - test 52 patterns)
│       └── test_perplexity.py         (MODIFY - remove formulaic tests)
└── docs/
    ├── CHANGELOG.md                (UPDATE - v6.0.0 entry)
    └── stories/
        ├── 2.2.pragmatic-markers-dimension.md  (UPDATE - mark as refactored)
        └── 2.4.0.5.refactor-transition-pragmatic-dimensions.md  (THIS FILE)
```

### Pattern Allocation

**Pragmatic Markers** (52 patterns → pragmatic_markers.py):
```python
EPISTEMIC_HEDGES = {
    'might', 'may', 'could', 'possibly', 'perhaps', 'presumably',
    'conceivably', 'potentially', 'it_seems', 'it_appears',
    'suggests_that', 'tends_to', 'likely_to',
    'about', 'almost', 'approximately', 'around', 'roughly',
    'generally', 'largely'  # 20 total
}

FREQUENCY_HEDGES = {
    'frequently', 'occasionally', 'sometimes', 'often', 'rarely', 'seldom'  # 6
}

EPISTEMIC_VERBS = {
    'assume', 'estimate', 'indicate', 'speculate', 'propose',
    'claim', 'argue', 'suggest'  # 8
}

CERTAINTY_MARKERS = {
    'definitely', 'certainly', 'clearly', 'obviously', 'undoubtedly',
    'I_believe', 'We_believe', 'I_think', 'We_think', 'without_doubt'  # 10
}

SPEECH_ACT_PATTERNS = {
    'I_argue', 'We_propose', 'We_suggest', 'I_contend',
    'it_can_be_argued', 'as_I_have_shown', 'I_claim', 'We_claim'  # 8
}
```

**Transition Markers** (Basic + Formulaic → transition_marker.py):
```python
# Basic transitions (existing)
BASIC_TRANSITIONS = {
    'however': AI 5-10+/1k, Human 0-3/1k
    'moreover': AI 3-8+/1k, Human 0-1/1k
    # Clustering detection
}

# Formulaic transitions (from utils/pattern_matching.py)
from writescore.utils.pattern_matching import FORMULAIC_TRANSITIONS
# Furthermore, Moreover, Additionally, In addition,
# First and foremost, In conclusion, To summarize, In summary,
# It is important to note that, It is worth mentioning that,
# When it comes to, With that said, Having said that, etc.
# 19 patterns
```

### Weight Distribution Rationale

**Original**: transition_marker.py = 10% (composite: 40% basic, 60% pragmatic)

**New Distribution**:
- **transition_marker.py**: 6% (basic 50% + formulaic 50%)
  - Rationale: Transitions are highly visible structural markers
  - Combined basic + formulaic provide strong AI signal
  - Research shows transition overuse is reliable discriminator

- **pragmatic_markers.py**: 4% (epistemic stance markers)
  - Rationale: More subtle linguistic features
  - Epistemic hedging shows moderate discrimination power
  - Supports transition markers as complementary signal

**Alternative considered**: 5% each (equal split) - Rejected because transitions show stronger empirical signal

### Scoring Strategy

**Transition Markers** (transition_marker.py):
```python
# Composite scoring
basic_score = _score_basic_transitions()      # however, moreover detection
formulaic_score = _score_formulaic_transitions()  # Furthermore, Moreover, etc.

# Equal weight to both aspects
final_score = (0.5 * basic_score) + (0.5 * formulaic_score)
```

**Pragmatic Markers** (pragmatic_markers.py):
```python
# Composite scoring (same as current)
hedging_score = _score_epistemic_hedging()     # 25%
certainty_score = _score_certainty_markers()   # 20%
speech_act_score = _score_speech_acts()        # 15%
frequency_score = _score_frequency_hedges()    # 20%
epistemic_verb_score = _score_epistemic_verbs()  # 20%

final_score = weighted_average(all_components)
```

### Testing Strategy

**Unit Tests**:
- Test all 52 pragmatic marker patterns individually
- Test all formulaic transition patterns (18)
- Test basic transition patterns (however, moreover)
- Test composite scoring for both dimensions
- Test edge cases (no markers, high density, clustering)

**Integration Tests**:
- Verify no pattern overlap between dimensions
- Test both dimensions contribute independently to aggregate score
- Verify dimension registry discovers all 3 files

**Regression Tests**:
- Compare aggregate scores on sample documents before/after
- Acceptable variance: ±5 points (due to weight redistribution)
- Flag dramatic changes (>10 points) for investigation

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-23 | 1.0 | Initial story created from dimension separation analysis | Sarah (Product Owner) |

---

## Dev Agent Record

> **Note**: This section will be populated by the development agent during implementation.

### Agent Model Used

_To be completed by dev agent_

### Debug Log References

_To be completed by dev agent_

### Completion Notes

_To be completed by dev agent_

### File List

**Files Created:**
- `.bmad-technical-writing/data/tools/writescore/dimensions/pragmatic_markers.py`
- `.bmad-technical-writing/data/tools/writescore/tests/unit/dimensions/test_pragmatic_markers.py`

**Files Modified:**
- `.bmad-technical-writing/data/tools/writescore/dimensions/transition_marker.py`
- `.bmad-technical-writing/data/tools/writescore/dimensions/perplexity.py`
- `.bmad-technical-writing/data/tools/writescore/tests/unit/dimensions/test_transition_marker.py`
- `.bmad-technical-writing/data/tools/writescore/tests/unit/dimensions/test_perplexity.py`
- `.bmad-technical-writing/data/tools/writescore/docs/stories/2.2.pragmatic-markers-dimension.md`
- `.bmad-technical-writing/data/tools/writescore/docs/CHANGELOG.md`

---

## QA Results

_To be completed by QA agent after implementation_

---

## Notes for Subsequent Stories

**Story 2.4.0.6** (AI Vocabulary Extraction):
- Depends on this story completing (perplexity.py formulaic transitions removed)
- Will extract AI vocabulary from perplexity.py → ai_vocabulary.py
- Perplexity.py will become empty shell ready for true perplexity implementation

**Story 2.4.0.7** (True Perplexity Implementation):
- Depends on Story 2.4.0.6 (AI vocabulary extracted)
- Will implement mathematical perplexity calculation
- perplexity.py will use language model (like predictability.py)

**Story 2.4.1** (Dimension Scoring Optimization):
- After all prerequisite stories complete
- Can proceed with 12 clearly-scoped dimensions
- Each dimension optimized independently
